<script>
// دالة لتطبيع الحروف العربية (إزالة الفروق)
function normalizeArabic(str) {
  return str
    .replace(/[أإآا]/g, "ا")
    .replace(/ى/g, "ي")
    .replace(/ة/g, "ه")
    .replace(/\s+/g, " ")
    .trim();
}

let studentsByClass = {}; // نخزن الأسماء لكل صف

async function loadStudents() {
  try {
    const response = await fetch("students_results.csv");
    const text = await response.text();
    const rows = text.split("\n").slice(1);

    studentsByClass = {};

    rows.forEach(row => {
      const cols = row.split(",");
      if (cols.length < 2) return;
      const name = cols[0].trim();
      const cls = cols[1].trim();

      if (!studentsByClass[cls]) studentsByClass[cls] = [];
      studentsByClass[cls].push(name);
    });

    // شيل التكرار
    for (let cls in studentsByClass) {
      studentsByClass[cls] = [...new Set(studentsByClass[cls])].sort();
    }

  } catch (e) {
    console.error("خطأ في تحميل الأسماء:", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  loadStudents();

  const classSelect = document.getElementById("studentClass");
  const nameField = document.getElementById("nameField");
  const studentNameInput = document.getElementById("studentName");
  const dataList = document.getElementById("namesList");

  classSelect.addEventListener("change", function() {
    const selectedClass = this.value;
    if (!selectedClass) {
      nameField.style.display = "none";
      return;
    }
    nameField.style.display = "block";

    // أول ما أختار الصف → امسح اللي فات
    studentNameInput.value = "";
    dataList.innerHTML = "";
  });

  studentNameInput.addEventListener("input", function() {
    const val = normalizeArabic(this.value);
    const selectedClass = classSelect.value;

    if (!selectedClass || val.length === 0) {
      dataList.innerHTML = "";
      return;
    }

    // فلترة سريعة من اللي متخزن
    const filtered = studentsByClass[selectedClass].filter(n =>
      normalizeArabic(n).includes(val)
    );

    dataList.innerHTML = "";
    filtered.forEach(n => {
      const option = document.createElement("option");
      option.value = n;
      dataList.appendChild(option);
    });
  });
});
</script>
